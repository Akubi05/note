# intro

单细胞 RNA 测序 (scRNA-seq) 技术已发展到以单细胞分辨率表征基因表达谱，从而提高了已知和新细胞类型的检测能力，以及对异质组织内细胞特异性分子过程和疾病失调的理解。然而，scRNA-seq 的广泛应用产生了许多庞大而复杂的数据集，这对整合来自不同批次和平台的数据集提出了新的计算挑战1,2,3,4。

scRNA-seq数据分析的一个基本任务是将细胞聚类到不同的组中作为候选细胞类型或细胞状态。这个任务对于来自单一来源的数据集可能很简单，但对于多源数据来说却非常困难，因为批次效应具有挑战的特点，尤其是在检测一些小簇时。虽然已经开发了几种方法来消除scRNA-seq分析中的批次效应，但其中大多数旨在消除嵌入空间中的批次效应，而没有考虑数据集中的聚类结构或局部结构。流行的方法如Seurat5,6,7和MNN8依赖于相互最近邻方法来消除批次效应，但MNN每次只能分析两个批次，因此其性能受到批次校正顺序的影响，并且当批次数量增加时它很快就会变得在计算上不可行。为此，研究人员引入了fastMNN9，从而显著提高了计算速度和准确性。另外两种方法 Scanorama10 和 BBKNN11 也在降维空间中搜索 MNN，并以相似性加权的方式使用它们来指导批次集成。此外，还开发了两种监督 MNN 方法 (SMNN12、iSMNN13) 来校正 scRNA-seq 的批次效应，但这两种方法要求不同批次之间的细胞类型完全相同。Zou 等人提出了基于残差神经网络的 DeepMNN14，该网络可最小化批次损失，即 PCA 子空间中 MNN 对之间的欧几里得距离之和。根据基准研究15,16，由于 Harmony 的运行时间明显较短，因此建议将其作为首选方法，其他方法也是可行的替代方案。 Luecken 等人 17 的基准研究也建议在复杂的集成任务中使用 scANVI18、scVI19 和 scanorama10，但 scANVI 的半监督模式和 scVI 的耗时问题阻碍了该应用。尽管 INSCT20 可以扩展到大型图谱并进行半监督分析，使用户能够通过将未标记的细胞投影到带有注释标签的参考中来对未标记的细胞进行分类，但它的稳健性和可重复性较差。BERMUDA21 的性能取决于 MetaNeighbor22，这限制了其可扩展性和准确性。Liger23 旨在使用集成非负矩阵分解消除技术差异，但其过程需要选择参考数据集（通常是细胞数量最多的数据集）。 scVI19 和 CarDEC24 也被设计用于同时消除批次效应和去噪基因表达，但最近的研究表明，这两种方法的解码器层输出的校正计数通常过度去噪25，这使得几乎所有的零表达值都变成非零。

现有的大多数方法首先消除批次效应，然后对细胞进行聚类。然而，此过程的缺点是，消除批次效应可能会导致原始稀有细胞类型信息丢失。因此，在本文中，我们从原始数据的先前聚类信息开始，然后利用带有三重态损失的深度度量学习框架下的批次内和批次间的最近邻（NN）信息，通过学习数据的低维表示来正确恢复真实的细胞类型并消除批次效应。最重要的是，scDML不受批次整合顺序的影响。在初始聚类中，我们首先以高分辨率对细胞进行聚类以保证初始聚类包含所有细微的和潜在的新型细胞类型，然后提出合并标准以优化最终的聚类数。该算法结合了基于图的聚类和层次聚类方法的优点，并通过将具有相同标签的点拉近并推开具有不同标签的点来同时消除批次效应。

在本研究中，我们将 scDML 应用于多个模拟数据集和来自不同物种和组织的大量真实 scRNA-seq 数据集，以证明其有效性。我们还将 scDML 与现有的最先进集成方法进行了比较。结果表明，scDML 可以恢复数据底层的生物层次结构，在固定数量的聚类下实现高聚类精度，并且可以很好地扩展到大型数据集。此外，scDML 是基于 PyTorch 框架开发的，并使用流行的 scRNA-seq 分析框架 Scanpy26 进行预处理，该框架可通过 https://github.com/eleozzr/scDML 免费获取。

# Results
## scDML 概述和评估

scDML 旨在对齐多批单细胞转录组数据，从而发现可能难以通过单独分析每批数据提取的稀有细胞类型。scDML 的工作流程如图 1 所示。在对 scRNA-seq 数据进行预处理（包括标准化、log1p 转换、查找高度可变的基因、缩放数据、PCA 嵌入）后，我们首先使用基于图的高分辨率聚类算法。然后，我们使用批次内和批次之间的 k 最近邻 (KNN) 和相互最近邻 (MNN) 信息来评估细胞簇之间的相似性，并构建具有层次结构的对称相似性矩阵。在给定高度（给定数量的簇）处切割树通常会产生以选定精度进行的分区聚类。scDML 应用了与 BERMUDA21 不同的合并规则，可以生成更稳定的结果。此外，scDML 利用层次聚类的思想逐个合并聚类。有关详细的合并过程，请参阅补充说明中的算法 1。在本文中，我们使用真实细胞类型的数量作为所有分析数据集的截止值，以评估所有比较方法的性能。为了成功消除批次效应，我们采用了考虑困难三元组的深度三元组学习，这有助于学习低维嵌入，该嵌入可以正确解释原始高维基因表达并同时消除批次效应（补充说明中的算法 2）。

采用常用的 UMAP27 方法可视化 scDML 和所有比较方法的结果。此外，采用三个指标（ARI28、NMI29、ASW_celltype15）评估聚类性能，采用三个指标（iLISI30、BatchKL31、ASW_batch15）评估消除批次效应的能力（有关指标的全名和定义，请参阅方法）。为了证明 scDML 的强度和可扩展性，我们分析了使用不同 scRNA-seq 协议生成的来自不同物种和组织的多个 scRNA-seq 数据集（补充数据 1）。将 scDML 的性能与 10 种旨在校正批次效应的方法进行了比较，包括 Seurat 37、Harmony30、Liger23、Scanorama10、scVI32、BERMUDA21、fastMNN9、BBKNN11、INSCT20、CarDEC24（补充表 1），以及批次集成之前的原始数据。scDML 使用的参数列在补充表 2、3 中。我们的结果表明，scDML 的表现始终优于这些现有方法，尤其是在保存稀有细胞类型的能力方面。

## scDML 消除了批次效应并保留了模拟数据中的真实结构

为了证明 scDML 的有效性，我们将我们的方法和 10 个最先进的竞争对手应用于两个模拟。在模拟 1 中，数据由 Luecken 等人 17 生成，包含 4 个批次的 4 种细胞类型。UMAP 图显示原始数据中存在严重的批次效应，而只有 scDML 彻底混合了不同批次的细胞并消除了批次效应（图 2a）。所有其他方法都按细胞类型和批次分离细胞，而 scDML 仅按细胞类型拆分细胞（图 2b）并在聚类结果中保留了真实的细胞类型（图 S2a）。此外，scDML 产生了最高的 ASW_celltype（图 2c）、ARI（高达 1.0）和 NMI（高达 1.0）（图 2e），表明其能够提高聚类准确性。尽管 scDML 在两个批量混合指标 iLISI 和 BatchKL 的综合评估中排名第三（图 2d），但前两种方法 Liger 和 INSCT 未能在其 UMAP 嵌入中恢复真实的细胞类型。
![figure2](/bio/scDML/pictures/41467_2023_36635_Fig2_HTML.webp)
- a 从比较方法计算出的 UMAP 嵌入，其中的点按批次着色。b 从比较方法计算出的 UMAP 嵌入，其中的点按细胞类型着色。c 条形图显示 ASW_celltype 和 ASW_batch 的值，其中条形高度表示 ASW_celltype 的值，点高度表示 ASW_batch 的值。ASW_celltype 越高，ASW_batch 越低，性能越好。d 散点图显示 BatchKL（x 轴）和 iLISI（y 轴）的值。点越靠近右上方，性能越好。误差带表示使用度为 3 的 B 样条平滑函数在平滑周围的 0.95 水平的置信区间。e 条形图显示不同方法的 ARI 和 NMI 值。条形越高，性能越好。源数据以源数据文件的形式提供。

在模拟 2 中，数据也是由 Luecken 等人 17 生成的，其中包含 6 个批次的 7 种细胞类型。除 BBKNN 之外，所有方法都很好地混合了不同批次（图 S1a），但只有 scDML、CarDEC、Harmony、fastMNN、Scanorama 和 scVI 呈现出真实的细胞类型和干净的簇（图 S1b、S2b），ARI 和 NMI 最高（图 S1e）。scDML 还产生了第二高的 ASW_cellytpe，仅略逊于 INSCT（图 S1c），然而，根据 UMAP 图，INSCT 明显破坏了原始数据结构。模拟表明，scDML 在消除批次效应、保留细胞类型和聚类准确性方面优于其他竞争方法。

## scDML 消除了批次效应，并在真实数据集中保留了真实结构

接下来，我们评估了 scDML 在几个真实数据集上的性能。第一个数据集是来自三项独立研究 33、34、35 的乳腺上皮细胞数据集，包含 3 个批次和 3 种细胞类型，总共 9288 个细胞。结果表明，scDML 按细胞类型分离细胞并按批次混合细胞（图 S3a、b），提供干净的聚类（图 S3c），并实现了精确的聚类，ARI、NMI 排名最高，ASW_celltype 排名第二（图 S3e、f）。尽管 Liger 和 BERMUDA 显示出较高的批次混合指标（图 S3d），但它们在 UMAP 嵌入中错误地将细胞类型分为 basal 和 luminal_progenitor。尽管 CarDEC 的 ASW_celltype 最高，但其批次混合指标 BatchKL 和 iLISI 最差，其 UMAP 嵌入可以组合在一起，但无法混合不同的批次。scDML 每个步骤中的合并顺序表明，当簇数设置为 3 时，可以恢复真正的细胞类型（图 S4）。

为了验证 scDML 在一种细胞类型仅存在于单个批次中的极端情况下的灵活性，我们人为地从两个批次中移除了细胞类型 basal。scDML 表现出与真实乳腺上皮数据集相似的理想性能（图 S3g-l）。尽管 Harmony、Seurat 3、fastMNN 和 Scanorama 具有较高的 ARI 和 NMI，而 Liger 具有较高的 iLISI 和 BatchKL，但它们都在 UMAP 图中错误地将 basal 分成两部分（图 S3h）。scDML 在 UMAP 可视化和 ASW_celltype 方面表现优异（图 S3f、l），并且在批次混合和聚类准确度指标之间实现了最佳权衡（图 S3d、e、j、k）。

然后，我们在使用 5 种协议36、37、38、39、40、41 生成的组合人类胰腺数据集上将 scDML 与其他方法进行了比较，其中有 14,890 个细胞，由 8 个批次和 13 种细胞类型组成，由于强烈的批次效应，这带来了巨大的挑战。在 scDML 的 UMAP 图中，不同批次的细胞混合均匀，不同细胞类型的细胞完全分离（图 3a、S5a）。scDML 还产生最干净的簇（图 S5c）和最高的 ASW_celltype、ARI 和 NMI（图 3b、d），表明其能够提高聚类性能。尽管 Liger 和 Seurat 3 的批次混合指标高于 scDML（图 3c），但它们未能在其 UMAP 嵌入中分离一些罕见细胞类型（图 S5b）。我们还展示了 scDML 的一些迭代，很明显 scDML 在训练过程中收敛得非常快（图 S6）。

figure3
- a–f 为人类胰腺数据集：（a）根据比较方法计算出的 UMAP 嵌入，其中点按批次着色。b 条形图显示 ASW_celltype 和 ASW_batch 的值，其中条形高度表示 ASW_celltype 的值，点高度表示 ASW_batch 的值。ASW_celltype 越高、ASW_batch 越低意味着性能越好。c 散点图显示 BatchKL（x 轴）和 iLISI（y 轴）的值。点越靠近右上方意味着性能越好。误差带表示使用度等于 3 的 B 样条平滑函数在平滑周围的 0.95 水平的置信区间。d 条形图显示不同方法的 ARI 和 NMI 值。条形越高意味着性能越好。e 桑基图显示了簇标签和真实细胞类型标签之间的对应关系。f 根据 scDML 计算出的 UMAP 嵌入，突出显示的细胞类型是稀有细胞类型。 g、h 为猕猴视网膜数据集：（g）从 scDML 计算的 UMAP 嵌入，突出显示的细胞类型 OFFx 是细胞最少的细胞类型。h 条形图显示 ASW_celltype 和 ASW_batch 的值，其中条形高度表示 ASW_celltype 的值，点高度表示 ASW_batch 的值。较高的 ASW_celltype 和较低的 ASW_batch 意味着更好的性能。源数据以源数据文件的形式提供。


## scDML 识别细微细胞类型

仔细观察胰腺数据集，桑基图（图 3e）和聚类图（图 S5b）均表明 scDML 检测到的簇与预注释标签高度吻合。scDML 识别的簇与真实细胞类型最为一致，尤其是对于某些微小细胞类型，而其他方法则无法区分微小簇。当我们在图 3f 和 S5d 中突出显示稀有细胞类型（activated_stellate、endothelial、epsilon、巨噬细胞、mast、quiescent_stellate、schwann）时，只有 scDML 成功地将这些细胞类型划分为孤立的簇。

从猕猴视网膜数据集中可以得出类似的结论，该数据集具有多级批次，包含来自 2 个不同地区、4 只不同猕猴和 30 个不同样本的 30,302 个细胞42。 scDML 再次产生了理想的 UMAP 可视化效果（图 S7a）、优越的聚类结果（图 S7b）和顶级排名指标（图 3h、S7e、f）。同时，在图 3g 和 S7c 中，只有 scDML 成功识别了细微细胞类型 OFFx。事实证明，scDML 不仅保留了真实的生物变异，而且还特别恢复了细微的细胞类型。

## scDML 在跨物种整合数据集时发现新聚类

接下来，我们开始测试 scDML 是否可用于跨物种整合数据集。假设是联合分析至少可以保留从单独分析中获得的所有生物信息，并有可能检测出新的聚类。我们从人类和小鼠肺组织下载了两个 scRNA-seq 数据集43。标准预处理和降维表明这两个数据集几乎没有重叠（图 S8c），表明存在严重的批次效应。通过 scDML 整合和合并聚类后，观察到两个数据集在常见细胞类型方面存在大量重叠（图 4a）。

对于整合任务，Harmony、Seurat 和 scDML 在 ASW_celltype 方面优于其他方法（分别为 0.6242、0.6240 和 0.6239）（图 4b）。虽然 INSCT 实现了最佳的 BatchKL 和 iLISI 指数（图 4c），但由于其 ARI 和 NMI 最低，细胞类型之间的生物学差异完全消失（图 4d）。Liger 方法在批次混合方面仍然表现良好（图 4c），但在聚类准确度方面仍然不如 scDML、Seurat 3、Harmony、BERMUDA、scVI 和 Scanorama（图 4d）。

**最重要的是，经过整合分析，scDML 可以发现其他竞争方法可能遗漏的一些罕见和微小的亚型。如图所示**。4e、f 和 S9a 中，我们清楚地看到一些 B 细胞标记基因（CD79B、JCHAIN、IGHA2、IGHG2、IGHG3、IGHG4）在 scDML 的不同簇中表达。成纤维细胞（COL3A1、DCN）和内皮细胞（PRX、MMRN1）的一些标记基因在 scDML 中也明显表达。所有这些 scDML 标记基因的表达模式与图 S8a 中注释的细胞亚型一致。然而，最流行的方法 Seurat 3、Harmony 和 scVI 无法检测 B 细胞的细胞亚型（图 S9b、S10d），这进一步证明 scDML 可以整合不同物种各自的特征以获得更精细的发现。

figture 4
## scDML 可扩展至大规模数据集

随着 scRNA-seq 规模不断扩大，可扩展至大型数据集的方法变得越来越重要。为了评估 scDML 的可扩展性，我们分析了一个包含 833,206 个小鼠脑细胞的数据集，该数据集由两批小鼠脑数据组成，分别使用两种协议 Drop-seq44 和 SPLiT-seq45 获取。该数据集主要由细胞类型神经元 (560,672 个细胞) 主导，其他细胞类型很少见。尽管如此，scDML 仍然是将神经元与其他细胞类型分离的最佳方法 (图 5a、b)，并生成最孤立的簇 (图 S11a)，ARI 和 NMI 压倒性最高 (图 5c、S11d)。scDML 的 BatchKL 和 iLISI 指标仅次于 Liger (图 S11c)，但 Liger 牺牲了聚类准确性 (图 5c)。其他比较方法未能保持相对较好的细胞类型分离或批次混合（图 S11b、c）。由于内存占用巨大且运行时间长，我们将 Seurat 3、CarDEC 和 BERMUDA 排除在该数据集的比较方法之外。在大多数情况下，Louvain 对学习到的嵌入的聚类结果与 scDML 的重新分配标签一致，但 Louvain 很可能将一个大簇分成几个小簇。对于该数据集，与 Louvain 的结果相比，来自 scDML 重新分配标签的 ARI 和 NMI 得到了显着改善（ARI 从 0.277 到 0.847，NMI 从 0.580 到 0.773），这意味着 scDML 的学习到的嵌入具有生物学意义。

图 5d、e 显示了处理不同数量细胞时不同方法的运行时间和峰值内存使用情况。为了公平比较。所有评估均在 Ubuntu 16.04.7 LTS 上完成，配备 Intel® Core (TM) E5-2620 v4 CPU @2.10 GHz 和 128GB 内存，不包括预处理。虽然 INSCT 是最快的，但它牺牲了聚类准确性。BBKNN、Scanorama、Harmony、fastMNN 和 scVI 在 20,0000 个细胞下不到 15 分钟就完成了分析。scDML 的运行时间是在 CPU 上测试的，如果使用 GPU，时间会减少。至于内存使用情况，scDML 排名第三（6.5GB），仅次于 BBKNN 和 Scanorama，在 200,000 个细胞下分别为 3.72 GB 和 5.05 GB（图 5e）。相比之下，BERMUD、CarDEC 和 Seurat 3 存在严重的可扩展性问题。BERMUDA 在细胞数量超过 50,000 时由于运行时间长和内存需求巨大而提前中断，而 Seurat 3 在细胞数量超过 200,000 时由于内存限制而无法整合大型数据集。scDML 计算速度快且内存效率高，使其成为分析大规模单细胞转录组数据的理想工具。

figure 5

## scDML 能够整合大量批次

为了评估 scDML 在大样本/批次上的性能，我们首先利用了经过质量控制的 140 个批次 46 中的 485,193 个细胞核的正常人类心脏图谱。由于内存占用量大且运行时间长，我们排除了 Seurat 3、CarDEC 和 BERMUDA 作为此数据集的比较方法。如图 6a、S12a 所示，原始数据具有非常强的批次效应。与其他竞争方法相比，scDML 达到了最高的 ASW_celltype、最高的 ARI 和第二个 NMI（图 6b、d 和 S12）。虽然 Liger 和 INSCT 具有最佳的批次混合指标 BatchKL 和 iLISI，但它们牺牲了聚类准确性，ARI 和 NMI 最差（图 6d）。 UMAP 图还表明 scDML 能够检测到微小簇，例如间皮簇，而其他竞争方法几乎无法检测到（图 6a）。

为了进一步证明整合多级批次的能力，我们还分析了包括 269794 个细胞核/细胞（220752 个细胞核和 49042 个细胞）的心脏衰竭数据，其中 45 个样本来自 27 名健康供体和 18 名扩张型心肌病患者 47。scDML 不仅能够消除样本之间的批次效应，还能消除测序技术之间的批次效应（图 S13a、b、d）。此外，scDML 在聚类方面具有最佳性能，达到最高的 ARI 和 NMI，其次是 Harmony（图 S13c、f）。

figure6

## scDML 合并规则保留了原始数据的层次结构

为了证明所提出的 scDML 合并规则的优越性，我们利用小鼠视网膜数据集探索了详细的合并过程。该数据集有 14 种细胞类型，横跨 6 个重复，共有 23,494 个细胞48。如图 7b、f、S14b、c 所示，与其他方法相比，scDML 产生了 14 个与真实细胞类型标签精确匹配的簇，达到 ARI = 0.966，略逊于 fastMNN (ARI = 0.973) 和 Scanorama (ARI = 0.972)，最高 NMI = 0.934，其次是 fastMNN (ARI = 0.922) 和 Scanorama (NMI = 0.919)。此外，scDML 还实现了理想的批量混合（图 7d、e 和 S14a）

图 7a 中的桑基图显示了 scDML 合并过程的每个步骤，因为簇的数量从 16 个减少到 9 个。该数据集的原始文献提供了从真实细胞类型标签48 获得的层次结构，该结构被视为黄金标准并与 scDML 输出的层次结构进行比较。具体而言，当簇数为 14 时，细胞类型 BC5C 和 BC5B 被分成两个簇（见图 7a 中的第 3 列）。随着簇数量的减少，它们最终合并为一个簇，从此保持稳定，不再与其他簇合并（见倒数第 4 列）。同样，在最后一列中，相似的细胞类型 BC5A 和 BC5D 被追踪合并到簇 7，BC1A 和 BC1B 被追踪合并到簇 8。然而，诸如 BC8/9 和 BC2 等独特细胞类型（见最后一列中的簇 1 和 2）在合并过程中从未丢失或与其他细胞类型混合，即使它们是细微的细胞类型。从 scDML 获得的层次结构与从真实标签获得的层次结构一致。因此，我们得出结论，scDML 的合并规则确保最大程度地保留原始数据的层次结构（图 7c），同时保持较稀有的亚群可识别。

figure7

## scDML 对变化的参数具有鲁棒性

这里，我们讨论了变化的超参数对 scDML 性能的影响（补充表 2），包括初始聚类中的分辨率、n_cluster（最终定义的聚类数）、K_in（每个批次内的邻居数）、K_bw（批次之间的邻居数）、HVGs（高度可变基因的数量）。

首先，以猕猴数据集为例，我们为 Louvain 算法选择了三种不同的分辨率（3.0、6.0、9.0）、两种不同的高度可变基因数量（1000 和 2000）、三种合并后的聚类数（11、12 和 13）和 21 种不同的组合（K_bw、K_in）。我们使用 ARI 和 NMI 来衡量 scDML 的性能。从图 8a、b 中可以看出，scDML 对这些超参数非常稳健，其中 ARI 和 NMI 在所有情况下都大于 0.9。

以胰腺数据集为例，我们分别选择了 Louvain49 和 Leiden50 作为初始聚类方法，依次将分辨率从 2.0 提高到 9.0（聚类数量从 30 到 100），并计算 ARI 和 NMI。从图 8c、d 中可以看出，聚类数量随着分辨率的增加而增加，但分类准确率指标几乎没有波动，也不受初始聚类方法的影响。scDML 始终保持较高的 ARI 和接近 1 的 NMI。因此，scDML 对变化的超参数具有足够的鲁棒性。

figure8

# 讨论

许多 scRNA-seq 技术、工具和平台已经适用于跨不同组织、疾病状态或不同物种进行比较。这些不同的数据集需要能够协调单细胞测序技术固有的技术和生物批次效应的方法。因此，在本文中，我们开发了 scDML，这是一种整合多个 scRNA-seq 数据集以检测潜在的新簇并同时消除批次效应的方法。scDML 已使用来自不同物种（人类、猕猴、小鼠）和组织（胰腺、视网膜、大脑、肺）的模拟和真实数据集进行了广泛测试，这些数据集由不同的 scRNA-seq 协议生成。我们注意到，与目前最先进的 scRNA-seq 集成方法（例如 Seurat 3、fastMNN、Harmony、scVI、BERMUDA、Liger、Scanorama、BBKNN 和 INSCT）相比，scDML 实现了具有竞争力的聚类准确性和批次效应消除。此外，在可扩展性和内存使用方面，scDML 的表现优于大多数竞争方法。由于 scDML 是基于 PyTorch 框架开发的，因此它可以利用 GPU 来加速计算。

我们提出了一种考虑批次效应的顺序合并初始聚类的策略，即计算批次内的KNN对数和批次间的MNN对数，然后计算聚类的相似度，最后构建一个层次树，其中树的根是收集所有聚类后获得的唯一聚类，叶子是需要合并的聚类。此后，我们使用上述MNN来指导信息以构建更好的低维嵌入。通过这种方式，该过程保证了scDML在合并相同细胞类型、分离不同细胞类型和保留某些批次特有的细胞类型方面优于现有方法。**至于最终应该定义多少个聚类，我们提供了一种策略，通过谱聚类（补充说明中的算法3）的启发，自动推断具有相似矩阵特征值的聚类数量，或者根据相似矩阵的热图手动设置聚类数量**。补充表4列出了基于上述算法建议的聚类数量。图 S15a, b 表明 bct 和 bct_del 数据集的聚类数应设置为 3，与算法 3 的建议相同。对于肺数据集和猕猴视网膜数据集，算法 3 建议的聚类数分别为 [5,10,13,16,18] 和 [8,12,18]。在实际操作中，我们也可以根据标记基因手动合并相似的聚类。

最重要的是，scDML 的一个显著特点是它不仅保留了原始数据集的稀有细胞类型信息，而且还有可能发现稀有簇，而这些簇可能难以通过单独分析每个批次来提取，就像其他竞争方法一样。此外，scDML 可以恢复数据底层的层次结构，而这在比较的方法中大多被忽略。更重要的是，scDML 可扩展到大型数据集，能够处理多级批次数据集，并且对不同的超参数具有鲁棒性。因此，我们相信 scDML 将成为生物医学研究人员更好地解开复杂细胞异质性的宝贵工具。

此外，我们提出的合并规则不仅适用于多批次数据集，还可以提高单批次数据集的性能。我们在三个不同的数据集上将 scDML 与两种常用的聚类方法 Kmeans 和 Louvain 进行了比较。然后我们惊讶地发现，相对于 Kmeans 和 Louvain，scDML 的 ARI 和 NMI 都得到了改善（图 S16），这也证明了我们提出的方法的有效性和合理性。

我们方法的一个限制是 scDML 可以应用于具有分类结构的 scRNA-seq 数据集，而不适用于具有差异化结构的数据集。此外，与大多数批次效应消除方法一样，scDML 仅创建集成的低维嵌入，而不能像 CarDEC 那样提供校正的基因表达。未来，我们计划扩展 scDML 的应用，直接在基因表达水平上消除 scRNA-seq 的批次效应，从而进行下游差异表达分析。

总之，对真实数据集和模拟数据集的广泛基准测试表明，scDML 不仅可以更好地恢复生物学差异并消除批次效应，还可以保留稀有细胞类型结构并识别可能被单独分析忽略的新细胞类型。因此，我们预计 scDML 将成为全面分析多个 scRNA-seq 数据集的宝贵工具。最后，本文中描述的所有分析脚本都可通过 https://github.com/eleozzr/scDML_reproduce 获得，以重现结果和图表。

# methods
scDML 工作流程（图 1）主要涉及五个步骤，即预处理、基于 PC 嵌入初始化聚类、在 PCA 嵌入空间中查找 NN 对、构建聚类之间的相似性矩阵和深度度量学习。
步骤 1：预处理

预处理中有五个重要任务需要完成：过滤低质量细胞和基因、细胞标准化、对数标准化、检测高变异基因 (HVG) 和使用截断值进行 z 分数标准化。所有上述步骤均在 1.7.2 版本的 python 模块 scanpy26 中实现。

令 X 为一个 n×p 的 scRNA-seq 数据矩阵，有 n 个细胞、p 个基因和 M 个批次，令 xij 为细胞 i 中基因 j 的表达值。在过滤步骤中，我们首先删除 nGene <10 的低质量细胞并删除 nCells <3 的基因。在细胞标准化中，我们使用 sc.pp.normalize_total 函数将每个细胞的计数除以所有基因的总计数并乘以常数 10000，以获得标准化的表达 yij。然后我们使用 sc.pp.log1p 函数对 yij 进行对数变换。之后，我们使用 sc.pp.highly_variable_genes 选择高度可变的基因，然后在每个批次内使用 sc.pp.scale 缩放数据。

# Date availability

数据可用性

我们分析了多个已发表的 scRNA-seq 数据集和两个模拟数据集，可通过原始文章中报告的接入号获取。 
(1) 模拟数据集：由 Luecken 等人 17 的 splatter 生成，可通过 https://figshare.com/articles/dataset/Benchmarking_atlas-level_data_integration_in_single-cell_genomics_-_integration_task_datasets_Immune_and_pancreas_/12420968(sim1_1_norm.h5ad, sim2_2_norm.h5ad) 访问； 
(2) 乳腺上皮数据集：来自三个独立研究的乳腺上皮细胞，可从 https://doi.org/10.6084/m9.figshare.20499630.v256 下载； 
（3）人类胰腺数据集：我们使用了 Seurat 教程中预先注释的集合（https://satijalab.org/seurat/archive/v3.2/integration.html，标准工作流程），接入代码为“GSE81076”、“GSE85241”、“GSE86469”、“GSE84133”和“E-MTAB-5061 []”；
（4）猕猴视网膜数据集：“GSE118480”；
（5）小鼠视网膜数据集：“GSE81904”；
（6）小鼠大脑数据集：“GSE116470”和“GSE110823”，也可以从http://scanorama.csail.mit.edu/data.tar.gz下载；
（7）人类肺和小鼠肺数据集：“GSE133747”； 
（8）健康人体心脏数据集：https://www.heartcellatlas.org/，可从 https://doi.org/10.6084/m9.figshare.20499630.v256 下载；
（9）具有多级批次的故障人体心脏数据集：“GSE183852”；
（10）单批次数据集：分析的三个数据集由 Chen 等人处理。57 可从 https://drive.google.com/drive/folders/1BIZxZNbouPtGf_cyu7vM44G5EcbxECeu（Adam、Muraro 和 Quake_10X_Limb_Muscle）下载。
这些数据集的详细信息在补充数据 1 中描述。所有分析的数据集均可从 https://doi.org/10.6084/m9.figshare.20499630.v256 下载。支持本研究主要发现的所有其他相关数据均可在本文及其补充信息文件中找到。源数据随本文提供。

# Code availability

scDML 算法基于 PyTorch 框架以 Python 实现，可通过 https://github.com/eleozzr/scDML58 获取。手稿中呈现的所有分析和结果均可通过 https://github.com/eleozzr/scDML_reproduce 获取。scDML 已获得 MIT 许可。